name: PR Build Checks

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened

permissions:
  contents: read

jobs:
  validate-version-lockstep:
    name: Validate Version Lockstep
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Validate version lock-step
        run: |
          node <<'NODE'
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const chrome = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
          const firefox = JSON.parse(fs.readFileSync('manifest_firefox.json', 'utf8'));

          const versions = {
            'package.json': pkg.version,
            'manifest.json': chrome.version,
            'manifest_firefox.json': firefox.version
          };
          const unique = [...new Set(Object.values(versions))];
          if (unique.length !== 1) {
            console.error('Version mismatch detected:', versions);
            process.exit(1);
          }
          console.log(`Version lock-step valid: ${unique[0]}`);
          NODE

  build-firefox:
    name: Build Firefox Package
    runs-on: ubuntu-latest
    needs: validate-version-lockstep
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install dependencies
        shell: bash
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build Firefox extension package
        run: npm run build:firefox
